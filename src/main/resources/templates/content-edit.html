<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common :: head-with-datepicker('コンテンツ編集 - Skygarden')}"></head>
<body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/common :: sidebar}"></nav>
    
    <!-- Header (Mobile) -->
    <nav th:replace="~{fragments/common :: header}"></nav>
    
    <!-- Offcanvas Menu (Mobile) -->
    <div th:replace="~{fragments/common :: offcanvas}"></div>
    
    <main>
        <div class="flex-grow-1 d-flex justify-content-center align-items-center p-4 sky-content">
            <div class="w-100">
                <h2 class="text-center mb-3">コンテンツ入稿画面</h2>
                <div class="card border-warning rounded sky-bg-1">
                    <div class="card-body">
                        <form id="contentform" name="contentform" action="/webadmin/update_post" method="POST">
                            <!-- publish&preview -->
                            <div class="sky-control mb-2">
                                <div class="sky-control-publish">
                                    <!-- published -->
                                    <div class="sky-control-publish-input">
                                        <label for="schedule_published" class="sky-form-label fw-bold ms-1 mb-1">start</label>
                                        <input type="datetime-local" class="form-control border-warning sky-input" id="schedule_published" name="schedule_published" th:value="${schedule_published}" placeholder="Enter start" />
                                        <div class="invalid-feedback">日時形式で入力してください</div>
                                    </div>
                                    <!-- unpublished -->
                                    <div class="sky-control-publish-input">
                                        <label for="schedule_unpublished" class="sky-form-label fw-bold ms-1 mb-1">end</label>
                                        <input type="datetime-local" class="form-control border-warning sky-input" id="schedule_unpublished" name="schedule_unpublished" th:value="${schedule_unpublished}" placeholder="Enter end" />
                                        <div class="invalid-feedback">日時形式で入力してください</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <!-- publish -->
                                    <div class="form-check form-switch sky-Content-publish">
                                        <input class="form-check-input sky-input-switch" type="checkbox" role="switch" id="published" name="published" value="1" th:checked="${publishflg_keep == '1'}" />
                                        <label class="form-check-label ms-1 pt-1" for="published">publish</label>
                                    </div>
                                    <!-- preview -->
                                    <div class="sky-Content-preview">
                                        <a class="btn btn-warning sky-Content-preview-item sky-bg-2" id="preview-button">
                                            <img th:src="@{/common/image/preview.svg}" alt="preview" />
                                        </a>
                                    </div>
                                    <!-- delete -->
                                    <div th:if="${id != '' and id != null}" class="sky-Content-delete">
                                        <a class="btn btn-warning sky-Content-delete-item sky-bg-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                            <img th:src="@{/common/image/trash.svg}" alt="delete" />
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- template select -->
                            <div class="mb-3 sky-input-pulldown">
                                <label for="template" class="sky-form-label fw-bold ms-1">template</label>
                                <select class="form-select form-select-lg border-warning" aria-label=".form-select-lg example" id="template" name="template" th:utext="${templateOutput}"></select>
                            </div>
                            
                            <!-- title -->
                            <div class="mb-3">
                                <label for="title" class="sky-form-label fw-bold ms-1">title</label>
                                <input type="text" class="form-control sky-input" id="title" name="title" th:value="${title}" placeholder="Enter title" required />
                                <div class="ms-2 invalid-feedback"></div>
                            </div>
                            
                            <!-- head -->
                            <div class="mb-3">
                                <label for="head" class="sky-form-label fw-bold ms-1">head</label>
                                <textarea class="form-control border-warning sky-input sky-input-head" id="head" name="head" rows="10" placeholder="Enter head" th:text="${head}"></textarea>
                            </div>
                            
                            <!-- content -->
                            <div class="mb-3 position-relative">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="content" class="sky-form-label fw-bold ms-1">content</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <!-- 挿入ボタン群 -->
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Insert buttons">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#imageSelectModal" title="画像挿入">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                                </svg>
                                                画像
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#fileSelectModal" title="ファイル挿入">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                                                </svg>
                                                ファイル
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#movieSelectModal" title="動画挿入">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M0 12V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm6.79-6.907A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
                                                </svg>
                                                動画
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="insertBreakTag()" title="改行挿入">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0 4a.5.5 0 0 1 .5-.5h9a2.5 2.5 0 0 1 0 5h-1.293l.647.646a.5.5 0 0 1-.708.708l-1.5-1.5a.5.5 0 0 1 0-.708l1.5-1.5a.5.5 0 0 1 .708.708l-.647.646H11.5a1.5 1.5 0 0 0 0-3h-9a.5.5 0 0 1-.5-.5zm0 4a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z"/>
                                                </svg>
                                                改行
                                            </button>
                                        </div>
                                        <!-- コード/プレビュー切り替え -->
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Content view toggle">
                                            <button type="button" class="btn btn-warning active" id="codeViewBtn" onclick="showCodeView()">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
                                                </svg>
                                                コード
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" id="previewViewBtn" onclick="showPreviewView()">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                </svg>
                                                プレビュー
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- コード表示 -->
                                <textarea class="form-control border-warning sky-input sky-input-content" id="content" name="content" rows="10" placeholder="Enter content" th:text="${contentStr}"></textarea>
                                <!-- プレビュー表示 -->
                                <div class="form-control border-warning sky-input sky-input-content sky-content-preview d-none" id="contentPreview" style="min-height: 250px; overflow-y: auto; background-color: #fff;"></div>
                            </div>
                            
                            <!-- url -->
                            <div class="mb-3">
                                <label for="url" class="sky-form-label fw-bold ms-1">url</label>
                                <input type="text" class="form-control sky-input" id="url" name="url" th:value="${url}" placeholder="Enter url" required />
                                <div class="ms-2 invalid-feedback">urlの入力に誤りがあります</div>
                            </div>
                            
                            <!-- Save button -->
                            <div class="text-center">
                                <button type="button" class="btn btn-warning w-100 mb-2 mt-5 sky-submit sky-bg-2" data-bs-toggle="modal" data-bs-target="#submitModal">
                                    Save
                                </button>
                            </div>
                            
                            <input type="hidden" name="id" th:value="${id}" />
                            <input type="hidden" name="type" value="" />
                        </form>
                        
                        <!-- Delete form -->
                        <form id="deleteform" name="deleteform" action="/webadmin/delete_post" method="POST">
                            <input type="hidden" name="id" id="deleteId" th:value="${id}" />
                            <input type="hidden" name="mode" value="" />
                        </form>
                        
                        <!-- Preview form (POST for clean URL) -->
                        <form id="previewform" name="previewform" action="/webadmin/preview" method="POST" target="_blank">
                            <input type="hidden" name="template" id="preview_template" />
                            <input type="hidden" name="title" id="preview_title" />
                            <input type="hidden" name="head" id="preview_head" />
                            <input type="hidden" name="content" id="preview_content" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Submit Modal -->
    <div th:replace="~{fragments/common :: submit-modal}"></div>

    <!-- Delete Modal -->
    <div th:replace="~{fragments/common :: delete-modal}"></div>

    <!-- Image Select Modal -->
    <div class="modal fade" id="imageSelectModal" tabindex="-1" aria-labelledby="imageSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="imageSelectModalLabel">画像を選択</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="imageList" class="sky-list-container" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center align-items-center">
                    <button type="button" class="btn btn-secondary mx-3" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-warning px-4 mx-3" id="imageSelectBtn" data-bs-dismiss="modal">選択</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Select Modal -->
    <div class="modal fade" id="fileSelectModal" tabindex="-1" aria-labelledby="fileSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="fileSelectModalLabel">ファイルを選択</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="fileList" class="sky-list-container" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center align-items-center">
                    <button type="button" class="btn btn-secondary mx-3" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-warning px-4 mx-3" id="fileSelectBtn" data-bs-dismiss="modal">選択</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Movie Select Modal -->
    <div class="modal fade" id="movieSelectModal" tabindex="-1" aria-labelledby="movieSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="movieSelectModalLabel">動画を選択</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="movieList" class="sky-list-container" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center align-items-center">
                    <button type="button" class="btn btn-secondary mx-3" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-warning px-4 mx-3" id="movieSelectBtn" data-bs-dismiss="modal">選択</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{fragments/common :: footer}"></footer>
    
    <script>
        // 日時形式の変換（datetime-local形式を"yyyy-MM-dd HH:mm"形式に変換）
        function convertDateTimeFormat(value) {
            if (value && value.includes('T')) {
                return value.replace('T', ' ');
            }
            return value;
        }
        
        // コンテンツフォームを送信
        function submitContentForm() {
            var form = document.getElementById('contentform');
            if (form) {
                // 日時形式を変換
                var schedulePublished = document.getElementById('schedule_published');
                var scheduleUnpublished = document.getElementById('schedule_unpublished');
                if (schedulePublished && schedulePublished.value) {
                    schedulePublished.value = convertDateTimeFormat(schedulePublished.value);
                }
                if (scheduleUnpublished && scheduleUnpublished.value) {
                    scheduleUnpublished.value = convertDateTimeFormat(scheduleUnpublished.value);
                }
                form.submit();
            }
        }
        
        // プレビュー機能（新しいウィンドウで開く - POSTで送信）
        function preview() {
            // 隠しフォームを作成してPOSTで新しいタブに送信
            var previewForm = document.getElementById('previewform');
            
            // 現在のフォームの値を隠しフォームにコピー
            document.getElementById('preview_template').value = document.getElementById('template').value;
            document.getElementById('preview_title').value = document.getElementById('title').value;
            document.getElementById('preview_head').value = document.getElementById('head').value;
            document.getElementById('preview_content').value = document.getElementById('content').value;
            
            // 新しいタブで開く
            previewForm.submit();
        }
        
        // コード表示に切り替え
        function showCodeView() {
            var content = document.getElementById('content');
            var contentPreview = document.getElementById('contentPreview');
            var codeBtn = document.getElementById('codeViewBtn');
            var previewBtn = document.getElementById('previewViewBtn');
            
            content.classList.remove('d-none');
            contentPreview.classList.add('d-none');
            
            codeBtn.classList.add('active');
            codeBtn.classList.remove('btn-outline-warning');
            codeBtn.classList.add('btn-warning');
            
            previewBtn.classList.remove('active');
            previewBtn.classList.add('btn-outline-warning');
            previewBtn.classList.remove('btn-warning');
        }
        
        // プレビュー表示に切り替え
        function showPreviewView() {
            var content = document.getElementById('content');
            var contentPreview = document.getElementById('contentPreview');
            var codeBtn = document.getElementById('codeViewBtn');
            var previewBtn = document.getElementById('previewViewBtn');
            
            // ローディング表示
            contentPreview.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            content.classList.add('d-none');
            contentPreview.classList.remove('d-none');
            
            codeBtn.classList.remove('active');
            codeBtn.classList.add('btn-outline-warning');
            codeBtn.classList.remove('btn-warning');
            
            previewBtn.classList.add('active');
            previewBtn.classList.remove('btn-outline-warning');
            previewBtn.classList.add('btn-warning');
            
            // サーバーサイドで[movie]タグ等を変換
            var formData = new FormData();
            formData.append('contentText', content.value);
            
            fetch('/webadmin/convert_preview', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                return response.text();
            })
            .then(function(html) {
                contentPreview.innerHTML = html;
            })
            .catch(function(error) {
                console.error('Preview error:', error);
                // エラー時は元のHTMLをそのまま表示
                contentPreview.innerHTML = content.value;
            });
        }
        
        // 選択状態を管理する変数
        var selectedImage = null;
        var selectedFile = null;
        var selectedMovie = null;
        
        // 画像一覧を読み込む
        function loadImages() {
            var imageList = document.getElementById('imageList');
            imageList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            selectedImage = null;
            
            fetch('/webadmin/api/images')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.length === 0) {
                        imageList.innerHTML = '<p class="text-center text-muted">登録されている画像がありません</p>';
                        return;
                    }
                    var html = '';
                    data.forEach(function(item, index) {
                        var width = parseSize(item.head, 'width');
                        var height = parseSize(item.head, 'height');
                        var imageUrl = item.url ? '/' + item.url : '';
                        html += '<div class="sky-list-card image-item d-flex align-items-center gap-3" data-index="' + index + '" data-id="' + item.id + '" data-url="' + (item.url || '') + '" data-title="' + (item.title || '') + '" data-width="' + width + '" data-height="' + height + '">';
                        // サムネイル画像
                        html += '<div class="sky-modal-thumbnail">';
                        if (imageUrl) {
                            html += '<img src="' + imageUrl + '" alt="' + (item.title || '') + '" class="sky-modal-thumbnail-img">';
                        } else {
                            html += '<div class="sky-modal-thumbnail-placeholder">No Image</div>';
                        }
                        html += '</div>';
                        // 情報
                        html += '<div class="flex-grow-1">';
                        html += '<p class="mb-0 small text-muted">ID: ' + item.id + '</p>';
                        html += '<h5 class="mb-1">' + (item.title || '（タイトルなし）') + '</h5>';
                        html += '<p class="mb-0 small">URL: /' + (item.url || '') + '</p>';
                        if (width || height) {
                            html += '<p class="mb-0 small text-muted">サイズ: ' + (width || '自動') + ' x ' + (height || '自動') + '</p>';
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    imageList.innerHTML = html;
                    
                    // クリックイベントを追加
                    document.querySelectorAll('.image-item').forEach(function(el) {
                        el.addEventListener('click', function() {
                            document.querySelectorAll('.image-item').forEach(function(e) { e.style.boxShadow = ''; });
                            this.style.boxShadow = '0 0 0 .25rem rgba(13, 110, 253, .25)';
                            selectedImage = {
                                id: this.dataset.id,
                                url: this.dataset.url,
                                title: this.dataset.title,
                                width: this.dataset.width,
                                height: this.dataset.height
                            };
                        });
                    });
                })
                .catch(function(error) {
                    console.error('Error loading images:', error);
                    imageList.innerHTML = '<p class="text-center text-danger">画像の読み込みに失敗しました</p>';
                });
        }
        
        // ファイル一覧を読み込む
        function loadFiles() {
            var fileList = document.getElementById('fileList');
            fileList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            selectedFile = null;
            
            fetch('/webadmin/api/files')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.length === 0) {
                        fileList.innerHTML = '<p class="text-center text-muted">登録されているファイルがありません</p>';
                        return;
                    }
                    var html = '';
                    data.forEach(function(item, index) {
                        html += '<div class="sky-list-card file-item" data-index="' + index + '" data-id="' + item.id + '" data-url="' + (item.url || '') + '" data-title="' + (item.title || '') + '">';
                        html += '<p class="mb-0 small text-muted">ID: ' + item.id + '</p>';
                        html += '<h5 class="mb-1">' + (item.title || '（タイトルなし）') + '</h5>';
                        html += '<p class="mb-0 small">URL: /' + (item.url || '') + '</p>';
                        html += '</div>';
                    });
                    fileList.innerHTML = html;
                    
                    // クリックイベントを追加
                    document.querySelectorAll('.file-item').forEach(function(el) {
                        el.addEventListener('click', function() {
                            document.querySelectorAll('.file-item').forEach(function(e) { e.style.boxShadow = ''; });
                            this.style.boxShadow = '0 0 0 .25rem rgba(13, 110, 253, .25)';
                            selectedFile = {
                                id: this.dataset.id,
                                url: this.dataset.url,
                                title: this.dataset.title
                            };
                        });
                    });
                })
                .catch(function(error) {
                    console.error('Error loading files:', error);
                    fileList.innerHTML = '<p class="text-center text-danger">ファイルの読み込みに失敗しました</p>';
                });
        }
        
        // 動画一覧を読み込む
        function loadMovies() {
            var movieList = document.getElementById('movieList');
            movieList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            selectedMovie = null;
            
            fetch('/webadmin/api/movies')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.length === 0) {
                        movieList.innerHTML = '<p class="text-center text-muted">登録されている動画がありません</p>';
                        return;
                    }
                    var html = '';
                    data.forEach(function(item, index) {
                        var width = parseSize(item.head, 'width');
                        var height = parseSize(item.head, 'height');
                        var videoId = item.content || ''; // YouTubeビデオID
                        var thumbnailUrl = videoId ? 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg' : '';
                        html += '<div class="sky-list-card movie-item d-flex align-items-center gap-3" data-index="' + index + '" data-id="' + item.id + '" data-title="' + (item.title || '') + '" data-width="' + width + '" data-height="' + height + '">';
                        // YouTubeサムネイル
                        html += '<div class="sky-modal-thumbnail sky-modal-thumbnail-video">';
                        if (thumbnailUrl) {
                            html += '<img src="' + thumbnailUrl + '" alt="' + (item.title || '') + '" class="sky-modal-thumbnail-img">';
                            html += '<div class="sky-modal-play-icon">▶</div>';
                        } else {
                            html += '<div class="sky-modal-thumbnail-placeholder">No Video</div>';
                        }
                        html += '</div>';
                        // 情報
                        html += '<div class="flex-grow-1">';
                        html += '<p class="mb-0 small text-muted">ID: ' + item.id + '</p>';
                        html += '<h5 class="mb-1">' + (item.title || '（タイトルなし）') + '</h5>';
                        if (width || height) {
                            html += '<p class="mb-0 small text-muted">サイズ: ' + (width || '自動') + ' x ' + (height || '自動') + '</p>';
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    movieList.innerHTML = html;
                    
                    // クリックイベントを追加
                    document.querySelectorAll('.movie-item').forEach(function(el) {
                        el.addEventListener('click', function() {
                            document.querySelectorAll('.movie-item').forEach(function(e) { e.style.boxShadow = ''; });
                            this.style.boxShadow = '0 0 0 .25rem rgba(13, 110, 253, .25)';
                            selectedMovie = {
                                id: this.dataset.id,
                                title: this.dataset.title,
                                width: this.dataset.width,
                                height: this.dataset.height
                            };
                        });
                    });
                })
                .catch(function(error) {
                    console.error('Error loading movies:', error);
                    movieList.innerHTML = '<p class="text-center text-danger">動画の読み込みに失敗しました</p>';
                });
        }
        
        // JSONからサイズ情報を解析
        function parseSize(jsonStr, key) {
            if (!jsonStr || jsonStr === '{}') return '';
            try {
                if (jsonStr.includes('"' + key + '":"')) {
                    var start = jsonStr.indexOf('"' + key + '":"') + key.length + 4;
                    var end = jsonStr.indexOf('"', start);
                    if (end > start) {
                        return jsonStr.substring(start, end);
                    }
                }
            } catch (e) {}
            return '';
        }
        
        // 画像タグを挿入
        function insertImageTag() {
            if (!selectedImage) {
                alert('画像を選択してください');
                return;
            }
            var url = '/' + selectedImage.url;
            var tag = '<img src="' + url + '"';
            if (selectedImage.title) {
                tag += ' alt="' + selectedImage.title + '"';
            }
            if (selectedImage.width) {
                tag += ' width="' + selectedImage.width + '"';
            }
            if (selectedImage.height) {
                tag += ' height="' + selectedImage.height + '"';
            }
            tag += '>';
            insertAtCursor(tag);
        }
        
        // ファイルタグを挿入
        function insertFileTag() {
            if (!selectedFile) {
                alert('ファイルを選択してください');
                return;
            }
            var url = '/' + selectedFile.url;
            var title = selectedFile.title || 'ダウンロード';
            var tag = '<a href="' + url + '">' + title + '</a>';
            insertAtCursor(tag);
        }
        
        // 動画タグを挿入
        function insertMovieTag() {
            if (!selectedMovie) {
                alert('動画を選択してください');
                return;
            }
            var tag = '[movie id=' + selectedMovie.id;
            if (selectedMovie.width) {
                tag += ', width=' + selectedMovie.width;
            }
            if (selectedMovie.height) {
                tag += ', height=' + selectedMovie.height;
            }
            tag += ']';
            insertAtCursor(tag);
        }
        
        // カーソル位置にテキストを挿入
        function insertAtCursor(text) {
            var textarea = document.getElementById('content');
            var start = textarea.selectionStart;
            var end = textarea.selectionEnd;
            var before = textarea.value.substring(0, start);
            var after = textarea.value.substring(end);
            textarea.value = before + text + after;
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
        }
        
        // 改行タグを挿入
        function insertBreakTag() {
            insertAtCursor('<br>');
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Submit Modal - 登録ボタン
            var submitModalBtn = document.getElementById('submitModalBtn');
            if (submitModalBtn) {
                submitModalBtn.addEventListener('click', function() {
                    submitContentForm();
                });
            }
            
            // Delete Modal - 削除ボタン
            var deleteModalBtn = document.getElementById('deleteModalBtn');
            if (deleteModalBtn) {
                deleteModalBtn.addEventListener('click', function() {
                    var deleteForm = document.getElementById('deleteform');
                    if (deleteForm) {
                        deleteForm.submit();
                    }
                });
            }
            
            // Preview Button
            var previewBtn = document.getElementById('preview-button');
            if (previewBtn) {
                previewBtn.addEventListener('click', function() {
                    preview();
                });
            }
            
            // 画像選択モーダル
            var imageSelectModal = document.getElementById('imageSelectModal');
            if (imageSelectModal) {
                imageSelectModal.addEventListener('show.bs.modal', function() {
                    loadImages();
                });
            }
            var imageSelectBtn = document.getElementById('imageSelectBtn');
            if (imageSelectBtn) {
                imageSelectBtn.addEventListener('click', function() {
                    insertImageTag();
                });
            }
            
            // ファイル選択モーダル
            var fileSelectModal = document.getElementById('fileSelectModal');
            if (fileSelectModal) {
                fileSelectModal.addEventListener('show.bs.modal', function() {
                    loadFiles();
                });
            }
            var fileSelectBtn = document.getElementById('fileSelectBtn');
            if (fileSelectBtn) {
                fileSelectBtn.addEventListener('click', function() {
                    insertFileTag();
                });
            }
            
            // 動画選択モーダル
            var movieSelectModal = document.getElementById('movieSelectModal');
            if (movieSelectModal) {
                movieSelectModal.addEventListener('show.bs.modal', function() {
                    loadMovies();
                });
            }
            var movieSelectBtn = document.getElementById('movieSelectBtn');
            if (movieSelectBtn) {
                movieSelectBtn.addEventListener('click', function() {
                    insertMovieTag();
                });
            }
        });
    </script>
</body>
</html>
