<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common :: head('設定 - Skygarden')}"></head>
<body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/common :: sidebar}"></nav>
    
    <!-- Header (Mobile) -->
    <nav th:replace="~{fragments/common :: header}"></nav>
    
    <!-- Offcanvas Menu (Mobile) -->
    <div th:replace="~{fragments/common :: offcanvas}"></div>
    
    <style>
        /* カラーピッカーのスタイル */
        .color-picker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .color-wheel-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
        }
        .color-wheel {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(
                red, yellow, lime, aqua, blue, magenta, red
            );
            cursor: crosshair;
            position: relative;
        }
        .color-wheel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
            border-radius: 50%;
            background: radial-gradient(circle, white 0%, transparent 70%);
        }
        .color-wheel-selector {
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
        }
        .brightness-slider-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brightness-slider {
            flex: 1;
            height: 20px;
            border-radius: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #000, #fff);
            cursor: pointer;
        }
        .brightness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #333;
            cursor: pointer;
        }
        .color-preview-box {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 0 0 2px rgba(255,255,255,0.8), 0 0 2px rgba(0,0,0,0.8);
        }
        .color-input-group {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .color-input-group input[type="text"] {
            flex: 1;
        }
        .color-input-group input[type="color"] {
            width: 50px;
            height: 38px;
            padding: 2px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
        }
        /* モーダル内のスタイル調整 */
        #addElementModal .modal-body {
            padding: 20px 30px;
        }
        #addElementModal .form-label {
            font-weight: 600;
            margin-bottom: 8px;
        }
        #addElementModal .form-control {
            margin-bottom: 15px;
        }
        /* 要素リストのスタイル改善 */
        .element-item {
            margin-bottom: 8px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab;
            user-select: none;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .element-item:active {
            cursor: grabbing;
        }
        .element-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .element-item.drag-over {
            border-top: 3px solid #ffc107;
            margin-top: -3px;
        }
        .element-item .d-sm-flex {
            gap: 0;
        }
        .element-color-display {
            min-height: 45px;
            transition: background-color 0.2s ease;
        }
        .element-color-display span {
            text-shadow: 0 0 2px rgba(255,255,255,0.8), 0 0 2px rgba(0,0,0,0.8);
            font-weight: 500;
        }
        /* ドラッグハンドルのスタイル */
        .drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            background-color: rgba(0,0,0,0.05);
            cursor: grab;
            color: #666;
            transition: background-color 0.2s ease;
        }
        .drag-handle:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .drag-handle svg {
            width: 18px;
            height: 18px;
        }
        /* 要素追加ボタンのスタイル */
        .add-element-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            max-width: 280px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            background-color: #fff;
            color: #333;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .add-element-btn:hover {
            background-color: #ffc107;
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,193,7,0.3);
        }
        .add-element-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .add-element-btn svg {
            width: 16px;
            height: 16px;
            stroke-width: 2.5;
        }
        /* セクションボックスのスタイル */
        .setting-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setting-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }
    </style>
    
    <main>
        <section style="display: flex; padding-bottom: 200px;">
            <div class="flex-grow-1 d-flex justify-content-center align-items-center p-4">
                <div class="w-100 sky-Setting-content">
                    <h2 class="text-center">Setting</h2>
                    <div class="card border-warning rounded sky-Setting-card">
                        <div class="card-body">
                            <form id="settingsform" name="settingsform" action="/webadmin/setting_post" method="post">
                                <div class="setting-section">
                                    <h5 class="setting-section-title">elementColor</h5>
                                    <div class="d-flex justify-content-center mb-3">
                                        <button class="add-element-btn" id="add-element-button" type="button" data-bs-toggle="modal" data-bs-target="#addElementModal">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                                            </svg>
                                            要素を追加
                                        </button>
                                        <input id="elements-color-value" name="elements-color-value" type="hidden" />
                                    </div>
                                    <div id="elements">
                                        <div th:each="colorElement, iterStat : ${colorElements}" th:id="'element-' + ${iterStat.count}" data-name="colorelements" class="element-item" draggable="true">
                                            <div class="d-sm-flex">
                                                <div class="drag-handle" title="ドラッグして並び替え">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                                    </svg>
                                                </div>
                                                <div class="d-flex justify-content-center align-items-center w-100 element-color-display" th:style="'background-color: ' + ${colorElement.code}">
                                                    <span th:text="${colorElement.name}"></span>
                                                </div>
                                                <button class="btn btn-warning fw-bold sky-bg-2 delete-element-btn" type="button" th:data-index="${iterStat.count}" style="min-width: 100px;">
                                                    <img th:src="@{/common/image/trash.svg}" alt="delete" />
                                                </button>
                                            </div>
                                            <input type="hidden" th:id="'element-name-' + ${iterStat.count}" th:name="'element-name-' + ${iterStat.count}" th:value="${colorElement.name}" />
                                            <input type="hidden" th:id="'element-code-' + ${iterStat.count}" th:name="'element-code-' + ${iterStat.count}" th:value="${colorElement.code}" />
                                        </div>
                                    </div>
                                    
                                    <div id="template-element" class="flex setting-delete element-item" style="display: none;" draggable="true">
                                        <div class="d-sm-flex">
                                            <div class="drag-handle" title="ドラッグして並び替え">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                                </svg>
                                            </div>
                                            <div class="d-flex justify-content-center align-items-center w-100 element-color-display"></div>
                                            <button class="btn btn-warning fw-bold sky-bg-2 delete-element-btn" type="button" style="min-width: 100px;">
                                                <img th:src="@{/common/image/trash.svg}" alt="delete" />
                                            </button>
                                        </div>
                                        <input type="hidden" id="" name="" value="" />
                                        <input type="hidden" id="" name="" value="" />
                                    </div>
                                </div>
                                
                                <div class="setting-section">
                                    <h5 class="setting-section-title">デフォルト公開設定</h5>
                                    <div class="d-flex align-items-center">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input sky-input-switch" type="checkbox" role="switch" 
                                                   id="default-publish-on" name="default-publish-on" value="1" 
                                                   th:checked="${defaultPublishOn == '1'}" />
                                            <label class="form-check-label ms-2" for="default-publish-on">
                                                新規コンテンツ作成時にpublishをオンで開く
                                            </label>
                                        </div>
                                    </div>
                                    <p class="text-muted small mt-2 mb-0">オンにすると、コンテンツ入稿画面を開いた際にデフォルトでpublishがオンになります。</p>
                                </div>
                                
                                <div class="setting-section">
                                    <h5 class="setting-section-title">生成AI設定（OpenAI）</h5>
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input sky-input-switch" type="checkbox" role="switch" 
                                                       id="ai-generation-visible" name="ai-generation-visible" value="1" 
                                                       th:checked="${aiGenerationVisible == '1'}" />
                                                <label class="form-check-label ms-2" for="ai-generation-visible">
                                                    AI生成ボタンを表示する
                                                </label>
                                            </div>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">オンにすると、コンテンツ編集画面にAI生成ボタンが表示されます。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="openai-api-key" class="form-label">APIキー</label>
                                        <input type="text" class="form-control" id="openai-api-key" name="openai-api-key" 
                                               th:value="${openaiApiKey}" placeholder="sk-..." />
                                        <p class="text-muted small mt-1 mb-0">OpenAI APIキーを入力してください。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="openai-model" class="form-label">モデル</label>
                                        <select class="form-select" id="openai-model" name="openai-model">
                                            <!-- GPT-5シリーズ -->
                                            <optgroup label="GPT-5シリーズ">
                                                <option value="gpt-5.2" th:selected="${openaiModel == 'gpt-5.2'}">gpt-5.2</option>
                                                <option value="gpt-5.2-pro" th:selected="${openaiModel == 'gpt-5.2-pro'}">gpt-5.2-pro</option>
                                                <option value="gpt-5-mini" th:selected="${openaiModel == 'gpt-5-mini'}">gpt-5-mini</option>
                                                <option value="gpt-5-nano" th:selected="${openaiModel == 'gpt-5-nano'}">gpt-5-nano</option>
                                            </optgroup>
                                            <!-- GPT-4シリーズ -->
                                            <optgroup label="GPT-4シリーズ">
                                                <option value="gpt-4.1" th:selected="${openaiModel == 'gpt-4.1'}">gpt-4.1</option>
                                                <option value="gpt-4.1-mini" th:selected="${openaiModel == 'gpt-4.1-mini'}">gpt-4.1-mini</option>
                                                <option value="gpt-4o" th:selected="${openaiModel == 'gpt-4o'}">gpt-4o</option>
                                                <option value="gpt-4o-mini" th:selected="${openaiModel == 'gpt-4o-mini'}">gpt-4o-mini</option>
                                                <option value="gpt-4-turbo" th:selected="${openaiModel == 'gpt-4-turbo'}">gpt-4-turbo</option>
                                                <option value="gpt-4" th:selected="${openaiModel == 'gpt-4'}">gpt-4</option>
                                            </optgroup>
                                            <!-- Reasoning Models (o-series) -->
                                            <optgroup label="Reasoning Models (o-series)">
                                                <option value="o3" th:selected="${openaiModel == 'o3'}">o3</option>
                                                <option value="o3-pro" th:selected="${openaiModel == 'o3-pro'}">o3-pro</option>
                                                <option value="o4-mini" th:selected="${openaiModel == 'o4-mini'}">o4-mini</option>
                                                <option value="o4-mini-high" th:selected="${openaiModel == 'o4-mini-high'}">o4-mini-high</option>
                                                <option value="o1-preview" th:selected="${openaiModel == 'o1-preview'}">o1-preview</option>
                                                <option value="o1-mini" th:selected="${openaiModel == 'o1-mini'}">o1-mini</option>
                                            </optgroup>
                                            <!-- GPT-3.5シリーズ -->
                                            <optgroup label="GPT-3.5シリーズ">
                                                <option value="gpt-3.5-turbo" th:selected="${openaiModel == 'gpt-3.5-turbo'}">gpt-3.5-turbo</option>
                                            </optgroup>
                                        </select>
                                        <p class="text-muted small mt-1 mb-0">使用するOpenAIモデルを選択してください。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="openai-prompt-title" class="form-label">タイトル生成プロンプト</label>
                                        <textarea class="form-control" id="openai-prompt-title" name="openai-prompt-title" rows="3" 
                                                  th:text="${openaiPromptTitle}" 
                                                  placeholder="以下の情報を基に、適切なWebページのタイトルを1つ提案してください。&#10;情報: {userInput}&#10;タイトルは簡潔で、検索エンジン最適化を考慮したものにしてください。"></textarea>
                                        <p class="text-muted small mt-1 mb-0">{userInput}はユーザー入力に置き換えられます。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="openai-prompt-content" class="form-label">本文生成プロンプト</label>
                                        <textarea class="form-control" id="openai-prompt-content" name="openai-prompt-content" rows="3" 
                                                  th:text="${openaiPromptContent}" 
                                                  placeholder="以下の情報を基に、Webページの本文（HTML形式）を生成してください。&#10;情報: {userInput}&#10;適切なHTMLタグを使用し、読みやすい形式で作成してください。"></textarea>
                                        <p class="text-muted small mt-1 mb-0">{userInput}はユーザー入力に置き換えられます。</p>
                                    </div>
                                </div>
                                
                                <!-- メール設定 -->
                                <div class="setting-section">
                                    <h5 class="setting-section-title">メール通知設定</h5>
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input sky-input-switch" type="checkbox" role="switch" 
                                                       id="email-enabled" name="email-enabled" value="1" 
                                                       th:checked="${emailEnabled == '1'}" />
                                                <label class="form-check-label ms-2" for="email-enabled">
                                                    メール通知を有効にする
                                                </label>
                                            </div>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">オンにすると、コンテンツが公開された際にメール通知が送信されます。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email-to" class="form-label">送信先メールアドレス</label>
                                        <input type="text" class="form-control" id="email-to" name="email-to" 
                                               th:value="${emailTo}" placeholder="example@example.com, example2@example.com" />
                                        <p class="text-muted small mt-1 mb-0">カンマ区切りで複数のメールアドレスを指定できます。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email-from" class="form-label">送信元メールアドレス</label>
                                        <input type="text" class="form-control" id="email-from" name="email-from" 
                                               th:value="${emailFrom}" placeholder="noreply@example.com" />
                                        <p class="text-muted small mt-1 mb-0">メールの送信元アドレスを入力してください。</p>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email-base-url" class="form-label">ベースURL</label>
                                        <input type="text" class="form-control" id="email-base-url" name="email-base-url" 
                                               th:value="${emailBaseUrl}" placeholder="http://example.com" />
                                        <p class="text-muted small mt-1 mb-0">メール本文に含まれるコンテンツURLのベースURLを入力してください。</p>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label for="email-body-template" class="form-label mb-0">メール本文テンプレート</label>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="reset-email-body-btn">
                                                デフォルトに戻す
                                            </button>
                                        </div>
                                        <textarea class="form-control" id="email-body-template" name="email-body-template" rows="8" 
                                                  th:text="${emailBodyTemplate}" 
                                                  placeholder="新しいコンテンツが公開されました。&#10;&#10;タイトル: ###title###&#10;URL: ###url###&#10;公開日時: ###publish_date###&#10;&#10;ご確認ください。"></textarea>
                                        <p class="text-muted small mt-1 mb-0">
                                            ###title###、###url###、###publish_date###が実際の値に置き換えられます。
                                        </p>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-warning fw-bold sky-bg-2 sky-submit" data-bs-toggle="modal" data-bs-target="#submitModal">
                                    登録
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add Element Modal -->
    <div class="modal fade" id="addElementModal" tabindex="-1" aria-labelledby="addElementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="addElementModalLabel">構成要素の色を追加</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-element-name" class="form-label">要素名</label>
                        <input type="text" class="form-control" id="modal-element-name" placeholder="例: header, footer, sidebar">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">色を選択</label>
                        <div class="color-picker-container">
                            <div class="color-wheel-wrapper">
                                <canvas id="color-wheel-canvas" class="color-wheel" width="200" height="200"></canvas>
                                <div id="color-wheel-selector" class="color-wheel-selector"></div>
                            </div>
                            <div class="brightness-slider-container">
                                <span>暗</span>
                                <input type="range" id="brightness-slider" class="brightness-slider" min="0" max="100" value="100">
                                <span>明</span>
                            </div>
                            <div class="color-input-group">
                                <input type="text" class="form-control" id="modal-element-code" placeholder="#000000">
                                <input type="color" id="native-color-picker" value="#ff0000" title="システムカラーピッカー">
                            </div>
                            <div id="color-preview" class="color-preview-box" style="background-color: #ff0000;">
                                プレビュー
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-warning fw-bold sky-bg-2" id="modal-add-element-btn" data-bs-dismiss="modal">追加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div th:replace="~{fragments/common :: submit-modal}"></div>
    
    <!-- Footer -->
    <footer th:replace="~{fragments/common :: footer}"></footer>
    
    <script>
        // カラーピッカー関連の変数
        var colorWheelCanvas, colorWheelCtx, colorWheelSelector;
        var brightnessSlider, nativeColorPicker, colorCodeInput, colorPreview;
        var currentHue = 0, currentSaturation = 100, currentBrightness = 100;
        var isDragging = false;
        
        // HSVからRGBへの変換
        function hsvToRgb(h, s, v) {
            s = s / 100;
            v = v / 100;
            var c = v * s;
            var x = c * (1 - Math.abs((h / 60) % 2 - 1));
            var m = v - c;
            var r, g, b;
            
            if (h >= 0 && h < 60) { r = c; g = x; b = 0; }
            else if (h >= 60 && h < 120) { r = x; g = c; b = 0; }
            else if (h >= 120 && h < 180) { r = 0; g = c; b = x; }
            else if (h >= 180 && h < 240) { r = 0; g = x; b = c; }
            else if (h >= 240 && h < 300) { r = x; g = 0; b = c; }
            else { r = c; g = 0; b = x; }
            
            return {
                r: Math.round((r + m) * 255),
                g: Math.round((g + m) * 255),
                b: Math.round((b + m) * 255)
            };
        }
        
        // RGBからHexへの変換
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(function(x) {
                var hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }
        
        // Hexから RGB への変換
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        // RGBからHSVへの変換
        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, v = max;
            var d = max - min;
            s = max === 0 ? 0 : d / max;
            
            if (max === min) {
                h = 0;
            } else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return { h: h * 360, s: s * 100, v: v * 100 };
        }
        
        // カラーホイールを描画
        function drawColorWheel() {
            var centerX = 100, centerY = 100, radius = 100;
            
            for (var angle = 0; angle < 360; angle++) {
                var startAngle = (angle - 1) * Math.PI / 180;
                var endAngle = (angle + 1) * Math.PI / 180;
                
                colorWheelCtx.beginPath();
                colorWheelCtx.moveTo(centerX, centerY);
                colorWheelCtx.arc(centerX, centerY, radius, startAngle, endAngle);
                colorWheelCtx.closePath();
                
                var gradient = colorWheelCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                gradient.addColorStop(0, 'white');
                gradient.addColorStop(1, 'hsl(' + angle + ', 100%, 50%)');
                colorWheelCtx.fillStyle = gradient;
                colorWheelCtx.fill();
            }
        }
        
        // カラーホイールから色を取得
        function getColorFromWheel(x, y) {
            var centerX = 100, centerY = 100, radius = 100;
            var dx = x - centerX;
            var dy = y - centerY;
            var distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > radius) {
                dx = dx * radius / distance;
                dy = dy * radius / distance;
                distance = radius;
            }
            
            var angle = Math.atan2(dy, dx) * 180 / Math.PI;
            if (angle < 0) angle += 360;
            
            var saturation = (distance / radius) * 100;
            
            return { hue: angle, saturation: saturation };
        }
        
        // 色を更新
        function updateColor() {
            var rgb = hsvToRgb(currentHue, currentSaturation, currentBrightness);
            var hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            
            colorCodeInput.value = hex;
            nativeColorPicker.value = hex;
            colorPreview.style.backgroundColor = hex;
            
            // 明るい色の場合は黒文字、暗い色の場合は白文字
            var luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            colorPreview.style.color = luminance > 0.5 ? '#000' : '#fff';
        }
        
        // セレクターの位置を更新
        function updateSelectorPosition() {
            var centerX = 100, centerY = 100, radius = 100;
            var angle = currentHue * Math.PI / 180;
            var distance = (currentSaturation / 100) * radius;
            
            var x = centerX + distance * Math.cos(angle);
            var y = centerY + distance * Math.sin(angle);
            
            colorWheelSelector.style.left = x + 'px';
            colorWheelSelector.style.top = y + 'px';
            colorWheelSelector.style.display = 'block';
        }
        
        // カラーホイールのクリック/ドラッグ処理
        function handleColorWheelInteraction(e) {
            var rect = colorWheelCanvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            var color = getColorFromWheel(x, y);
            currentHue = color.hue;
            currentSaturation = color.saturation;
            
            updateSelectorPosition();
            updateColor();
        }
        
        function addElement() {
            var inputname = document.getElementById('modal-element-name');
            var inputcode = document.getElementById('modal-element-code');
            var templateElement = document.getElementById('template-element');
            var elementsContainer = document.getElementById('elements');
            
            if (inputname && inputcode && templateElement && elementsContainer && inputname.value !== '' && inputcode.value !== '') {
                var newelement = templateElement.cloneNode(true);
                var name = inputname.value;
                var colorcode = inputcode.value;
                var elements = document.querySelectorAll('[data-name="colorelements"]');
                var index = elements.length + 1;
                var nameInput = newelement.querySelector('input[type="hidden"]:first-of-type');
                var codeInput = newelement.querySelector('input[type="hidden"]:last-of-type');
                var colorDisplay = newelement.querySelector('.element-color-display');
                
                if (colorDisplay) {
                    colorDisplay.innerHTML = '<span>' + name + '</span>';
                    colorDisplay.style.backgroundColor = colorcode;
                }
                
                if (nameInput) {
                    nameInput.id = 'element-name-' + index;
                    nameInput.setAttribute('name', 'element-name-' + index);
                    nameInput.value = name;
                }
                if (codeInput) {
                    codeInput.id = 'element-code-' + index;
                    codeInput.setAttribute('name', 'element-code-' + index);
                    codeInput.value = colorcode;
                }
                newelement.id = 'element-' + index;
                newelement.setAttribute('data-name', 'colorelements');
                newelement.style.display = '';
                var deleteButton = newelement.querySelector('button');
                if (deleteButton) {
                    deleteButton.setAttribute('data-index', index);
                    deleteButton.addEventListener('click', function() {
                        deleteElement(index);
                    });
                }
                newelement.classList.remove('setting-template');
                elementsContainer.appendChild(newelement);
                
                // 新しい要素にドラッグイベントを追加
                addDragEvents(newelement);
                
                // モーダルの入力をリセット
                inputname.value = '';
                inputcode.value = '#ff0000';
                nativeColorPicker.value = '#ff0000';
                currentHue = 0;
                currentSaturation = 100;
                currentBrightness = 100;
                brightnessSlider.value = 100;
                updateSelectorPosition();
                updateColor();
                
                // モーダルは data-bs-dismiss="modal" で自動的に閉じられる
            } else {
                alert('要素名と色コードを入力してください。');
            }
        }
        
        function deleteElement(index) {
            var element = document.getElementById('element-' + index);
            if (element) {
                element.remove();
                var elements = document.querySelectorAll('[data-name="colorelements"]');
                for (var i = 0; i < elements.length; i++) {
                    var currentElement = elements[i];
                    currentElement.id = 'element-' + (i + 1);
                    var nameInput = currentElement.querySelector('input[type="hidden"]:first-of-type');
                    var codeInput = currentElement.querySelector('input[type="hidden"]:last-of-type');
                    if (nameInput) nameInput.id = 'element-name-' + (i + 1);
                    if (codeInput) codeInput.id = 'element-code-' + (i + 1);
                    var deleteButton = currentElement.querySelector('button');
                    if (deleteButton) {
                        deleteButton.setAttribute('data-index', i + 1);
                    }
                }
            }
        }
        
        function saveSubmit() {
            var elements = document.querySelectorAll('[data-name="colorelements"]');
            var elementsValue = '';
            for (var i = 1; i < elements.length + 1; i++) {
                var nameElement = document.getElementById('element-name-' + i);
                var codeElement = document.getElementById('element-code-' + i);
                if (nameElement && codeElement) {
                    elementsValue += nameElement.value + '=' + codeElement.value + '*';
                }
            }
            var colorValueElement = document.getElementById('elements-color-value');
            var settingsForm = document.getElementById('settingsform');
            if (colorValueElement && settingsForm) {
                colorValueElement.value = elementsValue;
                settingsForm.submit();
            }
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // カラーピッカーの初期化
            colorWheelCanvas = document.getElementById('color-wheel-canvas');
            colorWheelCtx = colorWheelCanvas.getContext('2d');
            colorWheelSelector = document.getElementById('color-wheel-selector');
            brightnessSlider = document.getElementById('brightness-slider');
            nativeColorPicker = document.getElementById('native-color-picker');
            colorCodeInput = document.getElementById('modal-element-code');
            colorPreview = document.getElementById('color-preview');
            
            // カラーホイールを描画
            drawColorWheel();
            
            // カラーホイールのイベント
            colorWheelCanvas.addEventListener('mousedown', function(e) {
                isDragging = true;
                handleColorWheelInteraction(e);
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    handleColorWheelInteraction(e);
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            // タッチイベント対応
            colorWheelCanvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                isDragging = true;
                var touch = e.touches[0];
                handleColorWheelInteraction(touch);
            });
            
            document.addEventListener('touchmove', function(e) {
                if (isDragging) {
                    var touch = e.touches[0];
                    handleColorWheelInteraction(touch);
                }
            });
            
            document.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            // 明度スライダーのイベント
            brightnessSlider.addEventListener('input', function() {
                currentBrightness = this.value;
                updateColor();
            });
            
            // ネイティブカラーピッカーのイベント
            nativeColorPicker.addEventListener('input', function() {
                var hex = this.value;
                colorCodeInput.value = hex;
                colorPreview.style.backgroundColor = hex;
                
                var rgb = hexToRgb(hex);
                if (rgb) {
                    var hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
                    currentHue = hsv.h;
                    currentSaturation = hsv.s;
                    currentBrightness = hsv.v;
                    brightnessSlider.value = currentBrightness;
                    updateSelectorPosition();
                    
                    var luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
                    colorPreview.style.color = luminance > 0.5 ? '#000' : '#fff';
                }
            });
            
            // 色コード入力のイベント
            colorCodeInput.addEventListener('input', function() {
                var hex = this.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                    nativeColorPicker.value = hex;
                    colorPreview.style.backgroundColor = hex;
                    
                    var rgb = hexToRgb(hex);
                    if (rgb) {
                        var hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
                        currentHue = hsv.h;
                        currentSaturation = hsv.s;
                        currentBrightness = hsv.v;
                        brightnessSlider.value = currentBrightness;
                        updateSelectorPosition();
                        
                        var luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
                        colorPreview.style.color = luminance > 0.5 ? '#000' : '#fff';
                    }
                }
            });
            
            // モーダルの追加ボタン
            var modalAddBtn = document.getElementById('modal-add-element-btn');
            if (modalAddBtn) {
                modalAddBtn.addEventListener('click', function() {
                    addElement();
                });
            }
            
            // モーダルが開いたときに初期化
            var addElementModal = document.getElementById('addElementModal');
            if (addElementModal) {
                addElementModal.addEventListener('shown.bs.modal', function() {
                    // 初期色を設定
                    currentHue = 0;
                    currentSaturation = 100;
                    currentBrightness = 100;
                    brightnessSlider.value = 100;
                    updateSelectorPosition();
                    updateColor();
                });
            }
            
            // Delete Element Buttons
            var deleteButtons = document.querySelectorAll('.delete-element-btn');
            deleteButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var index = this.getAttribute('data-index');
                    deleteElement(parseInt(index, 10));
                });
            });
            
            // Submit Modal - 登録ボタン
            var submitModalBtn = document.getElementById('submitModalBtn');
            if (submitModalBtn) {
                submitModalBtn.addEventListener('click', function() {
                    saveSubmit();
                });
            }
            
            // ドラッグ＆ドロップの初期化
            initDragAndDrop();
        });
        
        // ドラッグ＆ドロップ関連
        var draggedElement = null;
        
        function initDragAndDrop() {
            var elementsContainer = document.getElementById('elements');
            
            // 既存の要素にイベントを設定
            var items = elementsContainer.querySelectorAll('[data-name="colorelements"]');
            items.forEach(function(item) {
                addDragEvents(item);
            });
            
            // コンテナのイベント
            elementsContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            elementsContainer.addEventListener('drop', function(e) {
                e.preventDefault();
            });
        }
        
        function addDragEvents(element) {
            element.addEventListener('dragstart', handleDragStart);
            element.addEventListener('dragend', handleDragEnd);
            element.addEventListener('dragover', handleDragOver);
            element.addEventListener('dragleave', handleDragLeave);
            element.addEventListener('drop', handleDrop);
        }
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            // すべての要素からdrag-overクラスを削除
            var items = document.querySelectorAll('[data-name="colorelements"]');
            items.forEach(function(item) {
                item.classList.remove('drag-over');
            });
            draggedElement = null;
            // インデックスを再割り当て
            reindexElements();
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedElement !== this) {
                var elementsContainer = document.getElementById('elements');
                var allItems = Array.from(elementsContainer.querySelectorAll('[data-name="colorelements"]'));
                var draggedIndex = allItems.indexOf(draggedElement);
                var targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    // 下に移動
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    // 上に移動
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
            
            this.classList.remove('drag-over');
        }
        
        function reindexElements() {
            var elements = document.querySelectorAll('[data-name="colorelements"]');
            elements.forEach(function(element, index) {
                var newIndex = index + 1;
                element.id = 'element-' + newIndex;
                
                var nameInput = element.querySelector('input[type="hidden"]:first-of-type');
                var codeInput = element.querySelector('input[type="hidden"]:last-of-type');
                var deleteButton = element.querySelector('.delete-element-btn');
                
                if (nameInput) {
                    nameInput.id = 'element-name-' + newIndex;
                    nameInput.setAttribute('name', 'element-name-' + newIndex);
                }
                if (codeInput) {
                    codeInput.id = 'element-code-' + newIndex;
                    codeInput.setAttribute('name', 'element-code-' + newIndex);
                }
                if (deleteButton) {
                    deleteButton.setAttribute('data-index', newIndex);
                }
            });
        }
        
        // メール本文テンプレートをデフォルトに戻す
        document.getElementById('reset-email-body-btn').addEventListener('click', function() {
            var defaultTemplate = '新しいコンテンツが公開されました。\n\n' +
                'タイトル: ###title###\n' +
                'URL: ###url###\n' +
                '公開日時: ###publish_date###\n\n' +
                'ご確認ください。';
            document.getElementById('email-body-template').value = defaultTemplate;
        });
    </script>
</body>
</html>
