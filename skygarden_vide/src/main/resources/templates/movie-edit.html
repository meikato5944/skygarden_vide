<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common :: head-with-datepicker('動画管理 - Skygarden')}"></head>
<body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/common :: sidebar}"></nav>
    
    <!-- Header (Mobile) -->
    <nav th:replace="~{fragments/common :: header}"></nav>
    
    <!-- Offcanvas Menu (Mobile) -->
    <div th:replace="~{fragments/common :: offcanvas}"></div>
    
    <main>
        <div class="flex-grow-1 d-flex justify-content-center align-items-center p-4 sky-content">
            <div class="w-100">
                <h2 class="text-center mb-3">動画入稿画面</h2>
                <div class="card border-warning rounded sky-bg-1">
                    <div class="card-body">
                        <form id="movieform" name="movieform" action="/webadmin/movie_register" method="POST">
                            <!-- publish&preview -->
                            <div class="sky-control mb-2">
                                <div class="sky-control-publish">
                                    <!-- published -->
                                    <div class="sky-control-publish-input">
                                        <label for="schedule_published" class="sky-form-label fw-bold ms-1 mb-1">start</label>
                                        <input type="datetime-local" class="form-control border-warning sky-input" id="schedule_published" name="schedule_published" th:value="${schedule_published}" placeholder="Enter start" />
                                        <div class="invalid-feedback">日時形式で入力してください</div>
                                    </div>
                                    <!-- unpublished -->
                                    <div class="sky-control-publish-input">
                                        <label for="schedule_unpublished" class="sky-form-label fw-bold ms-1 mb-1">end</label>
                                        <input type="datetime-local" class="form-control border-warning sky-input" id="schedule_unpublished" name="schedule_unpublished" th:value="${schedule_unpublished}" placeholder="Enter end" />
                                        <div class="invalid-feedback">日時形式で入力してください</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <!-- publish -->
                                    <div class="form-check form-switch sky-Content-publish">
                                        <input class="form-check-input sky-input-switch" type="checkbox" role="switch" id="published" name="published" value="1" th:checked="${publishflg_keep == '1'}" />
                                        <label class="form-check-label ms-1 pt-1" for="published">publish</label>
                                    </div>
                                    <!-- delete -->
                                    <div th:if="${id != '' and id != null}" class="sky-Content-delete">
                                        <a class="btn btn-warning sky-Content-delete-item sky-bg-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                            <img th:src="@{/common/image/trash.svg}" alt="delete" />
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- title -->
                            <div class="mb-3">
                                <label for="title" class="sky-form-label fw-bold ms-1">タイトル</label>
                                <input type="text" class="form-control sky-input" id="title" name="title" th:value="${title}" placeholder="動画のタイトルを入力" required />
                                <div class="ms-2 invalid-feedback">タイトルを入力してください</div>
                            </div>
                            
                            <!-- YouTube URL -->
                            <div class="mb-3">
                                <label for="youtubeUrl" class="sky-form-label fw-bold ms-1">YouTube URL</label>
                                <input type="text" class="form-control sky-input" id="youtubeUrl" name="youtubeUrl" th:value="${url}" placeholder="例: https://www.youtube.com/watch?v=xxxxx" th:required="${id == '' or id == null}" />
                                <div class="ms-2 invalid-feedback">YouTube URLを入力してください</div>
                                <small class="form-text text-muted ms-1">対応形式: youtube.com/watch?v=xxx, youtu.be/xxx, youtube.com/embed/xxx</small>
                            </div>
                            
                            <!-- 動画サイズ指定 -->
                            <div class="mb-3">
                                <label class="sky-form-label fw-bold ms-1">動画サイズ（オプション）</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="movieWidth" class="form-label small ms-1">幅 (width)</label>
                                        <input type="text" class="form-control sky-input" id="movieWidth" name="movieWidth" th:value="${movieWidth}" placeholder="例: 560px, 100%" />
                                    </div>
                                    <div class="col-6">
                                        <label for="movieHeight" class="form-label small ms-1">高さ (height)</label>
                                        <input type="text" class="form-control sky-input" id="movieHeight" name="movieHeight" th:value="${movieHeight}" placeholder="例: 315px" />
                                    </div>
                                </div>
                                <small class="form-text text-muted ms-1">未指定の場合はレスポンシブ（16:9比率）で表示されます</small>
                            </div>
                            
                            <!-- 動画プレビュー -->
                            <div class="mb-3" id="videoPreviewContainer" th:style="${(contentStr != '' and contentStr != null) ? '' : 'display:none'}">
                                <label class="sky-form-label fw-bold ms-1">プレビュー</label>
                                <div class="border rounded p-2 bg-light text-center">
                                    <iframe id="videoPreview" 
                                            th:src="${(contentStr != '' and contentStr != null) ? 'https://www.youtube.com/embed/' + contentStr : ''}"
                                            width="100%" 
                                            height="315" 
                                            frameborder="0" 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                            allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                            
                            <!-- 埋め込みタグ表示（編集時のみ） -->
                            <div class="mb-3" th:if="${id != '' and id != null}">
                                <label class="sky-form-label fw-bold ms-1">記事内での記述</label>
                                <div class="input-group">
                                    <input type="text" class="form-control sky-input" readonly id="embedTag" />
                                    <button class="btn btn-outline-warning" type="button" onclick="copyEmbedTag()">コピー</button>
                                </div>
                                <small class="form-text text-muted ms-1">記事内にこのタグを貼り付けると動画が表示されます</small>
                            </div>
                            
                            <!-- 現在のビデオID（編集時のみ表示） -->
                            <div class="mb-3" th:if="${contentStr != '' and contentStr != null}">
                                <label class="sky-form-label fw-bold ms-1">ビデオID</label>
                                <input type="text" class="form-control sky-input" th:value="${contentStr}" readonly disabled />
                            </div>
                            
                            <!-- Save button -->
                            <div class="text-center">
                                <button type="button" class="btn btn-warning w-100 mb-2 mt-5 sky-submit sky-bg-2" data-bs-toggle="modal" data-bs-target="#submitModal">
                                    Save
                                </button>
                            </div>
                            
                            <input type="hidden" name="id" th:value="${id}" />
                        </form>
                        
                        <!-- Delete form -->
                        <form id="deleteform" name="deleteform" action="/webadmin/delete_post" method="POST">
                            <input type="hidden" name="id" id="deleteId" th:value="${id}" />
                            <input type="hidden" name="mode" value="movie" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Submit Modal -->
    <div th:replace="~{fragments/common :: submit-modal}"></div>

    <!-- Delete Modal -->
    <div th:replace="~{fragments/common :: delete-modal}"></div>

    <!-- Footer -->
    <footer th:replace="~{fragments/common :: footer}"></footer>
    
    <script>
        // 日時形式の変換（datetime-local形式を"yyyy-MM-dd HH:mm"形式に変換）
        function convertDateTimeFormat(value) {
            if (value && value.includes('T')) {
                return value.replace('T', ' ');
            }
            return value;
        }
        
        // 動画フォームを送信
        function submitMovieForm() {
            var form = document.getElementById('movieform');
            if (form) {
                // 日時形式を変換
                var schedulePublished = document.getElementById('schedule_published');
                var scheduleUnpublished = document.getElementById('schedule_unpublished');
                if (schedulePublished && schedulePublished.value) {
                    schedulePublished.value = convertDateTimeFormat(schedulePublished.value);
                }
                if (scheduleUnpublished && scheduleUnpublished.value) {
                    scheduleUnpublished.value = convertDateTimeFormat(scheduleUnpublished.value);
                }
                form.submit();
            }
        }
        
        // YouTube URLからビデオIDを抽出
        function extractVideoId(url) {
            if (!url) return null;
            
            // youtu.be形式
            var match = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
            if (match) return match[1];
            
            // youtube.com/watch?v= 形式
            match = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
            if (match) return match[1];
            
            // youtube.com/embed/ 形式
            match = url.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/);
            if (match) return match[1];
            
            return null;
        }
        
        // 動画プレビュー機能
        function previewVideo(url) {
            var container = document.getElementById('videoPreviewContainer');
            var preview = document.getElementById('videoPreview');
            
            var videoId = extractVideoId(url);
            if (videoId) {
                preview.src = 'https://www.youtube.com/embed/' + videoId;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        // 埋め込みタグを生成
        function generateEmbedTag() {
            var embedTag = document.getElementById('embedTag');
            var movieIdInput = document.querySelector('input[name="id"]');
            var movieId = movieIdInput ? movieIdInput.value : '';
            var width = document.getElementById('movieWidth').value.trim();
            var height = document.getElementById('movieHeight').value.trim();
            
            if (!embedTag || !movieId) return;
            
            var tag = '[movie id=' + movieId;
            if (width) {
                tag += ', width=' + width;
            }
            if (height) {
                tag += ', height=' + height;
            }
            tag += ']';
            
            embedTag.value = tag;
        }
        
        // 埋め込みタグをコピー
        function copyEmbedTag() {
            var embedTag = document.getElementById('embedTag');
            if (embedTag) {
                embedTag.select();
                document.execCommand('copy');
                alert('埋め込みタグをコピーしました');
            }
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Submit Modal - 登録ボタン
            var submitModalBtn = document.getElementById('submitModalBtn');
            if (submitModalBtn) {
                submitModalBtn.addEventListener('click', function() {
                    submitMovieForm();
                });
            }
            
            // Delete Modal - 削除ボタン
            var deleteModalBtn = document.getElementById('deleteModalBtn');
            if (deleteModalBtn) {
                deleteModalBtn.addEventListener('click', function() {
                    var deleteForm = document.getElementById('deleteform');
                    if (deleteForm) {
                        deleteForm.submit();
                    }
                });
            }
            
            // YouTube URL入力時にプレビュー
            var youtubeUrlInput = document.getElementById('youtubeUrl');
            if (youtubeUrlInput) {
                youtubeUrlInput.addEventListener('blur', function() {
                    previewVideo(this.value);
                });
                youtubeUrlInput.addEventListener('paste', function() {
                    var self = this;
                    setTimeout(function() {
                        previewVideo(self.value);
                    }, 100);
                });
            }
            
            // サイズ入力時に埋め込みタグを更新
            var widthInput = document.getElementById('movieWidth');
            var heightInput = document.getElementById('movieHeight');
            if (widthInput) {
                widthInput.addEventListener('input', generateEmbedTag);
            }
            if (heightInput) {
                heightInput.addEventListener('input', generateEmbedTag);
            }
            
            // 初期埋め込みタグを生成
            generateEmbedTag();
        });
    </script>
</body>
</html>
