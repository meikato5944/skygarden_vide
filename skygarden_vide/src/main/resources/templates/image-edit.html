<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common :: head-with-datepicker('画像管理 - Skygarden')}"></head>
<body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/common :: sidebar}"></nav>
    
    <!-- Header (Mobile) -->
    <nav th:replace="~{fragments/common :: header}"></nav>
    
    <!-- Offcanvas Menu (Mobile) -->
    <div th:replace="~{fragments/common :: offcanvas}"></div>
    
    <main>
        <div class="flex-grow-1 d-flex justify-content-center align-items-center p-4 sky-content">
            <div class="w-100">
                <h2 class="text-center mb-3">画像入稿画面</h2>
                <div class="card border-warning rounded sky-bg-1">
                    <div class="card-body">
                        <form id="imageform" name="imageform" action="/webadmin/image_upload" method="POST" enctype="multipart/form-data">
                            <!-- publish&preview -->
                            <div class="sky-control mb-2">
                                <div class="sky-control-publish">
                                    <!-- published -->
                                    <div class="sky-control-publish-input">
                                        <label for="schedule_published" class="sky-form-label fw-bold ms-1 mb-1">start</label>
                                        <input type="datetime-local" class="form-control border-warning sky-input" id="schedule_published" name="schedule_published" th:value="${schedule_published}" placeholder="Enter start" />
                                        <div class="invalid-feedback">日時形式で入力してください</div>
                                    </div>
                                    <!-- unpublished -->
                                    <div class="sky-control-publish-input">
                                        <label for="schedule_unpublished" class="sky-form-label fw-bold ms-1 mb-1">end</label>
                                        <input type="datetime-local" class="form-control border-warning sky-input" id="schedule_unpublished" name="schedule_unpublished" th:value="${schedule_unpublished}" placeholder="Enter end" />
                                        <div class="invalid-feedback">日時形式で入力してください</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <!-- publish -->
                                    <div class="form-check form-switch sky-Content-publish">
                                        <input class="form-check-input sky-input-switch" type="checkbox" role="switch" id="published" name="published" value="1" th:checked="${publishflg_keep == '1'}" />
                                        <label class="form-check-label ms-1 pt-1" for="published">publish</label>
                                    </div>
                                    <!-- delete -->
                                    <div th:if="${id != '' and id != null}" class="sky-Content-delete">
                                        <a class="btn btn-warning sky-Content-delete-item sky-bg-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                            <img th:src="@{/common/image/trash.svg}" alt="delete" />
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 画像アップロード -->
                            <div class="mb-3">
                                <label for="file" class="sky-form-label fw-bold ms-1">画像ファイル</label>
                                <input type="file" class="form-control sky-input" id="file" name="file" accept="image/*" th:required="${id == '' or id == null}" />
                                <div class="ms-2 invalid-feedback">画像ファイルを選択してください</div>
                                <small class="form-text text-muted ms-1">対応形式: JPEG, PNG, GIF, WebP (最大10MB)</small>
                            </div>
                            
                            <!-- 画像プレビュー -->
                            <div class="mb-3" id="imagePreviewContainer" th:style="${(contentStr != '' and contentStr != null) ? '' : 'display:none'}">
                                <label class="sky-form-label fw-bold ms-1">プレビュー</label>
                                <div class="border rounded p-2 bg-light text-center">
                                    <img id="imagePreview" 
                                         th:src="${(url != '' and url != null) ? '/' + url : ''}" 
                                         alt="画像プレビュー" 
                                         style="max-width: 100%; max-height: 300px;" />
                                </div>
                            </div>
                            
                            <!-- title -->
                            <div class="mb-3">
                                <label for="title" class="sky-form-label fw-bold ms-1">タイトル</label>
                                <input type="text" class="form-control sky-input" id="title" name="title" th:value="${title}" placeholder="画像のタイトルを入力" required />
                                <div class="ms-2 invalid-feedback">タイトルを入力してください</div>
                            </div>
                            
                            <!-- url (物理パス) -->
                            <div class="mb-3">
                                <label for="url" class="sky-form-label fw-bold ms-1">URL（物理パス）</label>
                                <input type="text" class="form-control sky-input" id="url" name="url" th:value="${url}" placeholder="例: images/hero.jpg" required />
                                <div class="ms-2 invalid-feedback">URLを入力してください</div>
                                <small class="form-text text-muted ms-1">記事内で &lt;img src="/images/hero.jpg"&gt; のように指定できます</small>
                            </div>
                            
                            <!-- 画像サイズ指定 -->
                            <div class="mb-3">
                                <label class="sky-form-label fw-bold ms-1">画像サイズ（オプション）</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="imageWidth" class="form-label small ms-1">幅 (width)</label>
                                        <input type="text" class="form-control sky-input" id="imageWidth" name="imageWidth" th:value="${imageWidth}" placeholder="例: 300px, 100%" />
                                    </div>
                                    <div class="col-6">
                                        <label for="imageHeight" class="form-label small ms-1">高さ (height)</label>
                                        <input type="text" class="form-control sky-input" id="imageHeight" name="imageHeight" th:value="${imageHeight}" placeholder="例: 200px" />
                                    </div>
                                </div>
                                <small class="form-text text-muted ms-1">未指定の場合は元のサイズで表示されます</small>
                            </div>
                            
                            <!-- 現在のファイル名（編集時のみ表示） -->
                            <div class="mb-3" th:if="${contentStr != '' and contentStr != null}">
                                <label class="sky-form-label fw-bold ms-1">現在のファイル</label>
                                <input type="text" class="form-control sky-input" th:value="${contentStr}" readonly disabled />
                                <small class="form-text text-muted ms-1">新しい画像をアップロードすると上書きされます</small>
                            </div>
                            
                            <!-- 埋め込みタグ表示（編集時のみ） -->
                            <div class="mb-3" th:if="${id != '' and id != null and url != '' and url != null}">
                                <label class="sky-form-label fw-bold ms-1">記事内での記述</label>
                                <div class="input-group">
                                    <input type="text" class="form-control sky-input" readonly id="embedTag" />
                                    <button class="btn btn-outline-warning" type="button" onclick="copyEmbedTag()">コピー</button>
                                </div>
                                <small class="form-text text-muted ms-1">記事内にこのタグを貼り付けると画像が表示されます</small>
                            </div>
                            
                            <!-- Save button -->
                            <div class="text-center">
                                <button type="button" class="btn btn-warning w-100 mb-2 mt-5 sky-submit sky-bg-2" data-bs-toggle="modal" data-bs-target="#submitModal">
                                    Save
                                </button>
                            </div>
                            
                            <input type="hidden" name="id" th:value="${id}" />
                        </form>
                        
                        <!-- Delete form -->
                        <form id="deleteform" name="deleteform" action="/webadmin/delete_post" method="POST">
                            <input type="hidden" name="id" id="deleteId" th:value="${id}" />
                            <input type="hidden" name="mode" value="image" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Submit Modal -->
    <div th:replace="~{fragments/common :: submit-modal}"></div>

    <!-- Delete Modal -->
    <div th:replace="~{fragments/common :: delete-modal}"></div>

    <!-- Footer -->
    <footer th:replace="~{fragments/common :: footer}"></footer>
    
    <script>
        // 日時形式の変換（datetime-local形式を"yyyy-MM-dd HH:mm"形式に変換）
        function convertDateTimeFormat(value) {
            if (value && value.includes('T')) {
                return value.replace('T', ' ');
            }
            return value;
        }
        
        // 画像フォームを送信
        function submitImageForm() {
            var form = document.getElementById('imageform');
            if (form) {
                // 日時形式を変換
                var schedulePublished = document.getElementById('schedule_published');
                var scheduleUnpublished = document.getElementById('schedule_unpublished');
                if (schedulePublished && schedulePublished.value) {
                    schedulePublished.value = convertDateTimeFormat(schedulePublished.value);
                }
                if (scheduleUnpublished && scheduleUnpublished.value) {
                    scheduleUnpublished.value = convertDateTimeFormat(scheduleUnpublished.value);
                }
                form.submit();
            }
        }
        
        // 画像プレビュー機能
        function previewImage(input) {
            var preview = document.getElementById('imagePreview');
            var container = document.getElementById('imagePreviewContainer');
            
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    container.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 埋め込みタグを生成
        function generateEmbedTag() {
            var embedTag = document.getElementById('embedTag');
            var urlInput = document.getElementById('url');
            var titleInput = document.getElementById('title');
            var widthInput = document.getElementById('imageWidth');
            var heightInput = document.getElementById('imageHeight');
            
            if (!embedTag || !urlInput) return;
            
            var url = urlInput.value.trim();
            var title = titleInput ? titleInput.value.trim() : '';
            var width = widthInput ? widthInput.value.trim() : '';
            var height = heightInput ? heightInput.value.trim() : '';
            
            if (!url) return;
            
            // URL先頭のスラッシュを確認
            if (!url.startsWith('/')) {
                url = '/' + url;
            }
            
            var tag = '<img src="' + url + '"';
            if (title) {
                tag += ' alt="' + title + '"';
            }
            if (width) {
                tag += ' width="' + width + '"';
            }
            if (height) {
                tag += ' height="' + height + '"';
            }
            tag += '>';
            
            embedTag.value = tag;
        }
        
        // 埋め込みタグをコピー
        function copyEmbedTag() {
            var embedTag = document.getElementById('embedTag');
            if (embedTag) {
                embedTag.select();
                document.execCommand('copy');
                alert('埋め込みタグをコピーしました');
            }
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Submit Modal - 登録ボタン
            var submitModalBtn = document.getElementById('submitModalBtn');
            if (submitModalBtn) {
                submitModalBtn.addEventListener('click', function() {
                    submitImageForm();
                });
            }
            
            // Delete Modal - 削除ボタン
            var deleteModalBtn = document.getElementById('deleteModalBtn');
            if (deleteModalBtn) {
                deleteModalBtn.addEventListener('click', function() {
                    var deleteForm = document.getElementById('deleteform');
                    if (deleteForm) {
                        deleteForm.submit();
                    }
                });
            }
            
            // ファイル選択時のプレビュー
            var fileInput = document.getElementById('file');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    previewImage(this);
                });
            }
            
            // サイズ入力時に埋め込みタグを更新
            var widthInput = document.getElementById('imageWidth');
            var heightInput = document.getElementById('imageHeight');
            var urlInput = document.getElementById('url');
            var titleInput = document.getElementById('title');
            
            if (widthInput) {
                widthInput.addEventListener('input', generateEmbedTag);
            }
            if (heightInput) {
                heightInput.addEventListener('input', generateEmbedTag);
            }
            if (urlInput) {
                urlInput.addEventListener('input', generateEmbedTag);
            }
            if (titleInput) {
                titleInput.addEventListener('input', generateEmbedTag);
            }
            
            // 初期埋め込みタグを生成
            generateEmbedTag();
        });
    </script>
</body>
</html>
